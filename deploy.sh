#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–µ–ø–ª–æ—è —Å–∞–π—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ nginx
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy.sh

SERVER="anton@85.192.30.220"
WEB_DIR="/home/anton/sites"
SSH_KEY="~/.ssh/id_rsa_server"

echo "üöÄ –î–µ–ø–ª–æ–π —Å–∞–π—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
echo "–°–µ—Ä–≤–µ—Ä: $SERVER"
echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $WEB_DIR"

# –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
echo "üì¶ –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
npm run build

# –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
echo "‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
scp -i $SSH_KEY -r dist/* $SERVER:$WEB_DIR/

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
ssh -i $SSH_KEY $SERVER "chmod 755 $WEB_DIR && chmod 755 $WEB_DIR/assets && chmod 644 $WEB_DIR/* && chmod 644 $WEB_DIR/assets/*"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å nginx
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ nginx..."
ssh -i $SSH_KEY $SERVER "echo '123456789987654321' | sudo -S systemctl status nginx --no-pager -l | head -10"

echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "üåê –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://85.192.30.220"
echo "üîß –ê–¥–º–∏–Ω–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É: http://85.192.30.220/?admin=true" 